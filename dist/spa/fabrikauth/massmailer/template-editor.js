(function(e){e.fn.aceEditor=function(r){var t=e.extend({showLineNumbers:!0,highlightActiveLine:!0,showPrintMargin:!0,printMarginColumn:72,showFoldWidgets:!1},r),n=e(this),i=e("<div/>").attr("id",n.attr("id")+"-editor");n.after(i);var o=ace.edit(i.attr("id"));return o.setOptions(t),o.getSession().setMode("ace/mode/django"),o.getSession().getDocument().setValue(n.hide().val()),o.getSession().on("change",(function(){n.val(o.getSession().getDocument().getValue())})),o},e((function(){var r,t=e("#id_language"),n=e("#id_use_markdown"),i=e("#id_html_enabled"),o=e("#id_wrap_columns"),a=0,c=0,l=e("#id_is_marketing");e("#id_useful_queries").select2().on("select2:select",(function(e){r=e.params.data.id,a=0,h()})).on("select2:unselect",(function(e){r=null,h()}));var s=e("#btn-page-previous");s.click((function(e){e.preventDefault(),a<=0||(a--,h())}));var d=e("#btn-page-next");d.click((function(e){e.preventDefault(),a>c||(a++,h())}));var p=e("#btn-page-previous, #btn-page-next"),u=e("#result-count"),g=e("#result-page");function h(){p.prop("disabled",null==r),g.parent().hide(),u.val(""),null!=r&&(p.prop("disabled",!0),e.post(PREVIEW_URL,{html_enabled:i.prop("checked"),use_markdown:n.prop("checked"),wrap_columns:o.val(),query:r,page:a,language:t.val(),is_marketing:l.prop("checked"),subject:m.getSession().getDocument().getValue(),plain:w.getSession().getDocument().getValue(),html:b.getSession().getDocument().getValue()}).then((function(r){r.error?e("#preview-error").text(r.error):(e("#preview-error").text(""),c=r.query.count,a=r.query.page,u.text(c),g.parent().toggle(!!c),s.prop("disabled",a<=0),d.prop("disabled",a>=c-1),c&&(g.val(a+1).attr("max",c),e("#preview-subject-error").text(r.render.subject.error?r.render.subject.error.msg:""),e("#preview-plain .preview-subject > div:last-child, #preview-html .preview-subject").text(r.render.subject.content),e("#preview-plain .preview-header > div:last-child, #preview-html .preview-header").text(r.render.header),e("#preview-plain .preview-content > div:last-child").text(r.render.plain.content),e("#preview-plain-error").text(r.render.plain.error?r.render.plain.error.msg:""),i.prop("checked")&&(e("#preview-html-error").text(r.render.html.error?r.render.html.error.msg:""),e("#preview-html .preview-content").html(r.render.html.content),n.prop("checked")&&b.getSession().getDocument().setValue(r.html_template))))})))}function v(){var r=i.prop("checked");n.parent().toggle(r),e('a[href="#preview-html"]').parent().toggle(r),r||e('a[href="#preview-plain"]').tab("show"),e(b.container).closest(".form-group").toggle(r),b.resize(),b.renderer.updateFull(),r&&b.setReadOnly(n.prop("checked")),h()}g.on("change",(function(){var e=g.val();a=Math.min(c,Math.max(1,e))-1,g.val(e),h()})).on("keydown",(function(e){13===e.keyCode&&e.preventDefault()}));var m=e("#id_subject").aceEditor({minLines:2,maxLines:10});m.getSession().on("change",debounce(h,500)),m.renderer.setScrollMargin(4,4);var w=e("#id_plain_body").aceEditor({minLines:10,maxLines:30});w.getSession().on("change",debounce(h,500)),w.renderer.setScrollMargin(4,4);var b=e("#id_html_body").aceEditor({minLines:10,maxLines:30});b.getSession().on("change",(function(){n.prop("checked")||debounce(h,1e3)})),o.on("change",debounce(h,500)),b.renderer.setScrollMargin(4,4),t.on("change",debounce(h,500)),i.on("change",v),n.on("change",v),v(),h()}))})(jQuery);