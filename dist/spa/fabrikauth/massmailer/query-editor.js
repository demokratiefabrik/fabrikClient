ace.define("ace/mode/custom_query_hl",(function(e,t,n){var r=e("ace/lib/oop"),a=e("ace/mode/text_highlight_rules").TextHighlightRules,s=function(){var e="and|or|not|is|between|alias|contain|contains|start|starts|end|ends|match|matches|does|doesn't|with|as",t="true|false|null|empty",n="concatpair|min|coalesce|concat|keystransform|valuestransform|rangestartswith|upper|daytransform|yeartransform|variance|lower|rangeendswith|minutetransform|substr|stddev|greatest|datetimedatetransform|secondtransform|max|monthtransform|sum|isempty|hourtransform|unaccent|avg|slicetransform|length|indextransform|count|now|keytransform|arraylentransform|weekdaytransform|least",r=this.createKeywordMapper({"support.function":n,"constant.language":t,keyword:e},"identifier"),a="(?:i)?",s="(?:(?:[1-9]\\d*)|(?:0))",o="(?:0[xX][\\dA-Fa-f]+)",i="(?:"+s+"|"+o+")",u="(?:[eE][+-]?\\d+)",l="(?:\\.\\d+)",c="(?:\\d+)",g="(?:(?:"+c+"?"+l+")|(?:"+c+"\\.))",d="(?:(?:"+g+"|"+c+")"+u+")",p="(?:"+d+"|"+g+")",m="\\\\(x[0-9A-Fa-f]{2}|[0-7]{3}|[\\\\abfnrtv'\"]|U[0-9A-Fa-f]{8}|u[0-9A-Fa-f]{4})";this.$rules={start:[{token:"comment",regex:"#.*$"},{token:"string",regex:a+'"(?=.)',next:"qqstring"},{token:"string",regex:a+"'(?=.)",next:"qstring"},{token:"constant.numeric",regex:p},{token:"constant.numeric",regex:i+"[lL]\\b"},{token:"constant.numeric",regex:i+"\\b"},{token:r,regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"},{token:"paren.lparen",regex:"[\\[\\(\\{]"},{token:"paren.rparen",regex:"[\\]\\)\\}]"},{token:"text",regex:"\\s+"}],qqstring:[{token:"constant.language.escape",regex:m},{token:"string",regex:"\\\\$",next:"qqstring"},{token:"string",regex:'"|$',next:"start"},{defaultToken:"string"}],qstring:[{token:"constant.language.escape",regex:m},{token:"string",regex:"\\\\$",next:"qstring"},{token:"string",regex:"'|$",next:"start"},{defaultToken:"string"}]}};r.inherits(s,a),t.CustomQueryRules=s})),ace.define("ace/mode/custom_query",(function(e,t,n){var r=e("ace/lib/oop"),a=e("ace/mode/text").Mode,s=e("ace/mode/custom_query_hl").CustomQueryRules,o=function(){this.HighlightRules=s};r.inherits(o,a),function(){this.$id="ace/mode/custom_query"}.call(o.prototype),t.Mode=o})),$((function(){$("#id_useful_with").select2(),$.fn.aceEditor=function(e){var t=$.extend({showLineNumbers:!1,highlightActiveLine:!0,showPrintMargin:!1,showFoldWidgets:!1},e),n=$(this),r=$("<div/>").attr("id",n.attr("id")+"-editor");n.after(r);var a=ace.edit(r.attr("id"));return a.setOptions(t),a.getSession().setMode("ace/mode/custom_query"),a.getSession().getDocument().setValue(n.hide().val()),a.getSession().on("change",(function(){n.val(a.getSession().getDocument().getValue())})),a};var e=$("#id_query"),t=$("#result-stats").hide(),n=$("#result-wrap"),r=$("#result-error"),a=$("#result-data"),s=$(".result-model"),o=$("#result-model-name"),i=$("#result-aliases"),u=$("#result-count"),l=$("#result-user-count"),c=$("#result-sql"),g=$("#result-pager"),d=$("#result-page"),p=$("#btn-page-previous"),m=$("#btn-page-next"),f=$("#btn-page-previous, #btn-page-next"),x=e.aceEditor({minLines:5,maxLines:20,tabSize:2,useSoftTabs:!0}),h=1,v=0;function k(){var e=x.getSession().getDocument().getValue();f.prop("disabled",!0),$.post(PREVIEW_URL,{query:e,page:h-1}).done((function(e){var x=!!e.error;if(t.toggle(!e.error),r.toggle(x),g.toggle(!x),a.toggle(!x),f.prop("disabled",x),n.toggleClass("panel-default",!x).toggleClass("panel-danger",x),e.error){var k="–";c.text(k),r.text(e.error)}else{if(v=e.count,h=Math.max(1,Math.min(v,h)),p.prop("disabled",h<=1),m.prop("disabled",h>=v),g.toggle(v>0),d.val(h),s.text(e.model),o.text(e.model_name),i.empty().append(e.aliases.map((function(e){return $("<li/>").append($("<code/>").text(e[0]+" → "+e[1]))}))),u.text(e.count),l.text(e.user_count),c.text(e.query),a.empty(),!e.result)return;for(let t in e.result){let n=e.result[t];a.append($("<tr>").append($("<th>").text(t)).append($("<th>").text(n.pk)));for(let e in n.fields){let t=n.fields[e],r=$("<tr>");r.append($("<td>").append($("<tt>").text(e))),r.append($("<td>").append($("<tt>").text(t))),a.append(r)}}}}))}x.getSession().getDocument().on("change",debounce(k,500)),p.click((function(e){e.preventDefault(),h<=0||(h--,k())})),m.click((function(e){e.preventDefault(),h>v||(h++,k())})),d.on("change",(function(){var e=d.val();h=Math.min(v,Math.max(1,e)),d.val(e),k()})).on("keydown",(function(e){13===e.keyCode&&e.preventDefault()})),$(".ins-model").click((function(e){e.preventDefault();var t=$(this),n=x.getSession().getDocument().getValue().split("\n");n=n.map((function(e){return e.match(/^\s*$|\s*#/)?e:"# "+e})),n.push(t.attr("data-clsname")),n.push("");var r=t.attr("data-alias");r&&(n.push("alias user = ."+r),n.push("")),x.getSession().getDocument().setValue(n.join("\n")),x.focus()})),$(".ins-enum ul > li > a").click((function(e){e.preventDefault();var t=$(this),n=t.closest("div").find("button").text().trim(),r=t.text().trim();x.insert(n+"."+r),x.focus()})),$(".ins-func").click((function(e){var t=$(this).text();x.insert(t+"()");var n=x.getCursorPosition();n.column-=1,x.moveCursorToPosition(n),x.focus()})),k()}));