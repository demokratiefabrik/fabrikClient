{"code":"ace.define(\"ace/mode/custom_query_hl\",(function(e,t,n){var r=e(\"ace/lib/oop\"),a=e(\"ace/mode/text_highlight_rules\").TextHighlightRules,s=function(){var e=\"and|or|not|is|between|alias|contain|contains|start|starts|end|ends|match|matches|does|doesn't|with|as\",t=\"true|false|null|empty\",n=\"concatpair|min|coalesce|concat|keystransform|valuestransform|rangestartswith|upper|daytransform|yeartransform|variance|lower|rangeendswith|minutetransform|substr|stddev|greatest|datetimedatetransform|secondtransform|max|monthtransform|sum|isempty|hourtransform|unaccent|avg|slicetransform|length|indextransform|count|now|keytransform|arraylentransform|weekdaytransform|least\",r=this.createKeywordMapper({\"support.function\":n,\"constant.language\":t,keyword:e},\"identifier\"),a=\"(?:i)?\",s=\"(?:(?:[1-9]\\\\d*)|(?:0))\",o=\"(?:0[xX][\\\\dA-Fa-f]+)\",i=\"(?:\"+s+\"|\"+o+\")\",u=\"(?:[eE][+-]?\\\\d+)\",l=\"(?:\\\\.\\\\d+)\",c=\"(?:\\\\d+)\",g=\"(?:(?:\"+c+\"?\"+l+\")|(?:\"+c+\"\\\\.))\",d=\"(?:(?:\"+g+\"|\"+c+\")\"+u+\")\",p=\"(?:\"+d+\"|\"+g+\")\",m=\"\\\\\\\\(x[0-9A-Fa-f]{2}|[0-7]{3}|[\\\\\\\\abfnrtv'\\\"]|U[0-9A-Fa-f]{8}|u[0-9A-Fa-f]{4})\";this.$rules={start:[{token:\"comment\",regex:\"#.*$\"},{token:\"string\",regex:a+'\"(?=.)',next:\"qqstring\"},{token:\"string\",regex:a+\"'(?=.)\",next:\"qstring\"},{token:\"constant.numeric\",regex:p},{token:\"constant.numeric\",regex:i+\"[lL]\\\\b\"},{token:\"constant.numeric\",regex:i+\"\\\\b\"},{token:r,regex:\"[a-zA-Z_$][a-zA-Z0-9_$]*\\\\b\"},{token:\"paren.lparen\",regex:\"[\\\\[\\\\(\\\\{]\"},{token:\"paren.rparen\",regex:\"[\\\\]\\\\)\\\\}]\"},{token:\"text\",regex:\"\\\\s+\"}],qqstring:[{token:\"constant.language.escape\",regex:m},{token:\"string\",regex:\"\\\\\\\\$\",next:\"qqstring\"},{token:\"string\",regex:'\"|$',next:\"start\"},{defaultToken:\"string\"}],qstring:[{token:\"constant.language.escape\",regex:m},{token:\"string\",regex:\"\\\\\\\\$\",next:\"qstring\"},{token:\"string\",regex:\"'|$\",next:\"start\"},{defaultToken:\"string\"}]}};r.inherits(s,a),t.CustomQueryRules=s})),ace.define(\"ace/mode/custom_query\",(function(e,t,n){var r=e(\"ace/lib/oop\"),a=e(\"ace/mode/text\").Mode,s=e(\"ace/mode/custom_query_hl\").CustomQueryRules,o=function(){this.HighlightRules=s};r.inherits(o,a),function(){this.$id=\"ace/mode/custom_query\"}.call(o.prototype),t.Mode=o})),$((function(){$(\"#id_useful_with\").select2(),$.fn.aceEditor=function(e){var t=$.extend({showLineNumbers:!1,highlightActiveLine:!0,showPrintMargin:!1,showFoldWidgets:!1},e),n=$(this),r=$(\"<div/>\").attr(\"id\",n.attr(\"id\")+\"-editor\");n.after(r);var a=ace.edit(r.attr(\"id\"));return a.setOptions(t),a.getSession().setMode(\"ace/mode/custom_query\"),a.getSession().getDocument().setValue(n.hide().val()),a.getSession().on(\"change\",(function(){n.val(a.getSession().getDocument().getValue())})),a};var e=$(\"#id_query\"),t=$(\"#result-stats\").hide(),n=$(\"#result-wrap\"),r=$(\"#result-error\"),a=$(\"#result-data\"),s=$(\".result-model\"),o=$(\"#result-model-name\"),i=$(\"#result-aliases\"),u=$(\"#result-count\"),l=$(\"#result-user-count\"),c=$(\"#result-sql\"),g=$(\"#result-pager\"),d=$(\"#result-page\"),p=$(\"#btn-page-previous\"),m=$(\"#btn-page-next\"),f=$(\"#btn-page-previous, #btn-page-next\"),x=e.aceEditor({minLines:5,maxLines:20,tabSize:2,useSoftTabs:!0}),h=1,v=0;function k(){var e=x.getSession().getDocument().getValue();f.prop(\"disabled\",!0),$.post(PREVIEW_URL,{query:e,page:h-1}).done((function(e){var x=!!e.error;if(t.toggle(!e.error),r.toggle(x),g.toggle(!x),a.toggle(!x),f.prop(\"disabled\",x),n.toggleClass(\"panel-default\",!x).toggleClass(\"panel-danger\",x),e.error){var k=\"–\";c.text(k),r.text(e.error)}else{if(v=e.count,h=Math.max(1,Math.min(v,h)),p.prop(\"disabled\",h<=1),m.prop(\"disabled\",h>=v),g.toggle(v>0),d.val(h),s.text(e.model),o.text(e.model_name),i.empty().append(e.aliases.map((function(e){return $(\"<li/>\").append($(\"<code/>\").text(e[0]+\" → \"+e[1]))}))),u.text(e.count),l.text(e.user_count),c.text(e.query),a.empty(),!e.result)return;for(let t in e.result){let n=e.result[t];a.append($(\"<tr>\").append($(\"<th>\").text(t)).append($(\"<th>\").text(n.pk)));for(let e in n.fields){let t=n.fields[e],r=$(\"<tr>\");r.append($(\"<td>\").append($(\"<tt>\").text(e))),r.append($(\"<td>\").append($(\"<tt>\").text(t))),a.append(r)}}}}))}x.getSession().getDocument().on(\"change\",debounce(k,500)),p.click((function(e){e.preventDefault(),h<=0||(h--,k())})),m.click((function(e){e.preventDefault(),h>v||(h++,k())})),d.on(\"change\",(function(){var e=d.val();h=Math.min(v,Math.max(1,e)),d.val(e),k()})).on(\"keydown\",(function(e){13===e.keyCode&&e.preventDefault()})),$(\".ins-model\").click((function(e){e.preventDefault();var t=$(this),n=x.getSession().getDocument().getValue().split(\"\\n\");n=n.map((function(e){return e.match(/^\\s*$|\\s*#/)?e:\"# \"+e})),n.push(t.attr(\"data-clsname\")),n.push(\"\");var r=t.attr(\"data-alias\");r&&(n.push(\"alias user = .\"+r),n.push(\"\")),x.getSession().getDocument().setValue(n.join(\"\\n\")),x.focus()})),$(\".ins-enum ul > li > a\").click((function(e){e.preventDefault();var t=$(this),n=t.closest(\"div\").find(\"button\").text().trim(),r=t.text().trim();x.insert(n+\".\"+r),x.focus()})),$(\".ins-func\").click((function(e){var t=$(this).text();x.insert(t+\"()\");var n=x.getCursorPosition();n.column-=1,x.moveCursorToPosition(n),x.focus()})),k()}));","name":"fabrikauth/massmailer/query-editor.js","input":"ace.define('ace/mode/custom_query_hl', function (require, exports, module) {\n\n  var oop = require(\"ace/lib/oop\");\n  var TextHighlightRules = require(\"ace/mode/text_highlight_rules\").TextHighlightRules;\n\n  var CustomQueryRules = function () {\n\n    var keywords = (\n      \"and|or|not|is|between|alias|contain|contains|start|starts|end|ends|match|matches|does|doesn't|with|as\"\n    );\n\n    var constants = (\n      \"true|false|null|empty\"\n    );\n\n    var funcs = (\n      \"concatpair|min|coalesce|concat|keystransform|valuestransform|rangestartswith|upper|daytransform|yeartransform|variance|lower|rangeendswith|minutetransform|substr|stddev|greatest|datetimedatetransform|secondtransform|max|monthtransform|sum|isempty|hourtransform|unaccent|avg|slicetransform|length|indextransform|count|now|keytransform|arraylentransform|weekdaytransform|least\"\n    );\n\n    var keywordMapper = this.createKeywordMapper({\n      \"support.function\": funcs,\n      \"constant.language\": constants,\n      \"keyword\": keywords\n    }, \"identifier\");\n\n    var strPre = \"(?:i)?\";\n\n    var decimalInteger = \"(?:(?:[1-9]\\\\d*)|(?:0))\";\n    var hexInteger = \"(?:0[xX][\\\\dA-Fa-f]+)\";\n    var integer = \"(?:\" + decimalInteger + \"|\" + hexInteger + \")\";\n\n    var exponent = \"(?:[eE][+-]?\\\\d+)\";\n    var fraction = \"(?:\\\\.\\\\d+)\";\n    var intPart = \"(?:\\\\d+)\";\n    var pointFloat = \"(?:(?:\" + intPart + \"?\" + fraction + \")|(?:\" + intPart + \"\\\\.))\";\n    var exponentFloat = \"(?:(?:\" + pointFloat + \"|\" + intPart + \")\" + exponent + \")\";\n    var floatNumber = \"(?:\" + exponentFloat + \"|\" + pointFloat + \")\";\n\n    var stringEscape = \"\\\\\\\\(x[0-9A-Fa-f]{2}|[0-7]{3}|[\\\\\\\\abfnrtv'\\\"]|U[0-9A-Fa-f]{8}|u[0-9A-Fa-f]{4})\";\n\n    this.$rules = {\n      start: [\n        {\n          token: 'comment',\n          regex: '#.*$'\n        },\n        {\n          token: \"string\",           // \" string\n          regex: strPre + '\"(?=.)',\n          next: \"qqstring\"\n        },\n        {\n          token: \"string\",           // ' string\n          regex: strPre + \"'(?=.)\",\n          next: \"qstring\"\n        },\n        {\n          token: \"constant.numeric\", // float\n          regex: floatNumber\n        }, {\n          token: \"constant.numeric\", // long integer\n          regex: integer + \"[lL]\\\\b\"\n        }, {\n          token: \"constant.numeric\", // integer\n          regex: integer + \"\\\\b\"\n        },\n        {\n          token: keywordMapper,\n          regex: \"[a-zA-Z_$][a-zA-Z0-9_$]*\\\\b\"\n        },\n        {\n          token: \"paren.lparen\",\n          regex: \"[\\\\[\\\\(\\\\{]\"\n        }, {\n          token: \"paren.rparen\",\n          regex: \"[\\\\]\\\\)\\\\}]\"\n        }, {\n          token: \"text\",\n          regex: \"\\\\s+\"\n        }\n      ],\n      \"qqstring\": [{\n        token: \"constant.language.escape\",\n        regex: stringEscape\n      }, {\n        token: \"string\",\n        regex: \"\\\\\\\\$\",\n        next: \"qqstring\"\n      }, {\n        token: \"string\",\n        regex: '\"|$',\n        next: \"start\"\n      }, {\n        defaultToken: \"string\"\n      }],\n      \"qstring\": [{\n        token: \"constant.language.escape\",\n        regex: stringEscape\n      }, {\n        token: \"string\",\n        regex: \"\\\\\\\\$\",\n        next: \"qstring\"\n      }, {\n        token: \"string\",\n        regex: \"'|$\",\n        next: \"start\"\n      }, {\n        defaultToken: \"string\"\n      }]\n    };\n  };\n\n  oop.inherits(CustomQueryRules, TextHighlightRules);\n  exports.CustomQueryRules = CustomQueryRules;\n});\n\nace.define('ace/mode/custom_query', function (require, exports, module) {\n\n  var oop = require(\"ace/lib/oop\");\n  var TextMode = require(\"ace/mode/text\").Mode;\n  var CustomQueryRules = require(\"ace/mode/custom_query_hl\").CustomQueryRules;\n\n  var Mode = function () {\n    this.HighlightRules = CustomQueryRules;\n  };\n  oop.inherits(Mode, TextMode);\n\n  (function () {\n    this.$id = \"ace/mode/custom_query\";\n  }).call(Mode.prototype);\n\n  exports.Mode = Mode;\n});\n\n$(function () {\n\n  $(\"#id_useful_with\").select2();\n\n  $.fn.aceEditor = function (options) {\n    var settings = $.extend({\n      showLineNumbers: false,\n      highlightActiveLine: true,\n      showPrintMargin: false,\n      showFoldWidgets: false,\n    }, options);\n\n    var $this = $(this);\n    var $editor = $('<div/>').attr('id', $this.attr('id') + '-editor');\n    $this.after($editor);\n    var editor = ace.edit($editor.attr('id'));\n    editor.setOptions(settings);\n    editor.getSession().setMode(\"ace/mode/custom_query\");\n    editor.getSession().getDocument().setValue($this.hide().val());\n    editor.getSession().on('change', function () {\n      $this.val(editor.getSession().getDocument().getValue());\n    });\n    return editor;\n  };\n\n  var $query = $(\"#id_query\");\n  var $result_stats = $('#result-stats').hide();\n  var $result_wrap = $('#result-wrap');\n  var $result_error = $('#result-error');\n  var $result_data = $('#result-data');\n  var $result_model = $('.result-model');\n  var $result_model_name = $('#result-model-name');\n  var $result_aliases = $('#result-aliases');\n  var $result_count = $('#result-count');\n  var $result_user_count = $('#result-user-count');\n  var $result_sql_query = $('#result-sql');\n  var $result_pager = $('#result-pager');\n  var $result_page = $('#result-page');\n  var $page_previous = $('#btn-page-previous');\n  var $page_next = $('#btn-page-next');\n  var $page_buttons = $('#btn-page-previous, #btn-page-next');\n\n  var editor = $query.aceEditor({\n    minLines: 5,\n    maxLines: 20,\n    tabSize: 2,\n    useSoftTabs: true\n  });\n\n  var page = 1, count = 0;\n\n  function preview() {\n    var query = editor.getSession().getDocument().getValue();\n    $page_buttons.prop('disabled', true);\n    $.post(PREVIEW_URL, {query: query, page: page - 1})\n      .done(function (data) {\n        var invalid = !!data.error;\n        $result_stats.toggle(!data.error);\n        $result_error.toggle(invalid);\n        $result_pager.toggle(!invalid);\n        $result_data.toggle(!invalid);\n        $page_buttons.prop('disabled', invalid);\n        $result_wrap\n          .toggleClass('panel-default', !invalid)\n          .toggleClass('panel-danger', invalid);\n        if(data.error) {\n          var e = '–';\n          $result_sql_query.text(e);\n          $result_error.text(data.error);\n        } else {\n          count = data.count;\n          page = Math.max(1, Math.min(count, page));\n          $page_previous.prop('disabled', page <= 1);\n          $page_next.prop('disabled', page >= count);\n          $result_pager.toggle(count > 0)\n          $result_page.val(page);\n          $result_model.text(data.model);\n          $result_model_name.text(data.model_name);\n          $result_aliases.empty().append(data.aliases.map(function(a) { return $('<li/>').append($('<code/>').text(a[0] + ' → ' + a[1])); }));\n          $result_count.text(data.count);\n          $result_user_count.text(data.user_count);\n          $result_sql_query.text(data.query);\n          $result_data.empty();\n          if (!data.result) return;\n          for (let name in data.result) {\n            let r = data.result[name];\n            $result_data.append($('<tr>').append($('<th>').text(name)).append($('<th>').text(r.pk)));\n            for (let field in r.fields) {\n              let value = r.fields[field];\n              let row = $('<tr>');\n              row.append($('<td>').append($('<tt>').text(field)));\n              row.append($('<td>').append($('<tt>').text(value)));\n              $result_data.append(row);\n            }\n          }\n        }\n      });\n  }\n\n  editor.getSession().getDocument().on('change', debounce(preview, 500));\n\n  $page_previous.click(function (e) {\n    e.preventDefault();\n    if (page <= 0)\n      return;\n    page--;\n    preview();\n  });\n  $page_next.click(function (e) {\n    e.preventDefault();\n    if (page > count)\n      return;\n    page++;\n    preview();\n  });\n  $result_page\n  .on('change', function () {\n    var want = $result_page.val();\n    page = Math.min(count, Math.max(1, want));\n    $result_page.val(want);\n    preview();\n  })\n  .on('keydown', function (e) {\n    // return submits the non existent form -_-\n    if (e.keyCode === 13) e.preventDefault();\n  });\n\n\n  // model name insert\n  $('.ins-model').click(function (e) {\n    e.preventDefault();\n    var $this = $(this);\n    var lines = editor.getSession().getDocument().getValue().split('\\n');\n    // comment lines\n    lines = lines.map(function (l) {\n      return l.match(/^\\s*$|\\s*#/) ? l : (\"# \" + l);\n    });\n    lines.push($this.attr('data-clsname'));\n    lines.push('');\n    var alias = $this.attr('data-alias');\n    if (alias) {\n      lines.push('alias user = .' + alias);\n      lines.push('');\n    }\n    editor.getSession().getDocument().setValue(lines.join('\\n'));\n    editor.focus();\n  });\n\n  // enum insert\n  $('.ins-enum ul > li > a').click(function (e) {\n    e.preventDefault();\n    var $this = $(this);\n    var name = $this.closest('div').find('button').text().trim();\n    var member = $this.text().trim();\n    editor.insert(name + '.' + member);\n    editor.focus();\n  });\n\n  // function insert\n  $('.ins-func').click(function (e) {\n    var name = $(this).text();\n    editor.insert(name + '()');\n    var pos = editor.getCursorPosition();\n    pos.column -= 1;\n    editor.moveCursorToPosition(pos);\n    editor.focus();\n  });\n\n  preview();\n\n});\n","inputSourceMap":null}